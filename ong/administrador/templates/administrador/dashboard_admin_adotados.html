<!-- Html da página dashboard_admin_adotados
Página do dashboard de mostra os gatos que estão adotados -->


{% extends "ong/base_admin.html" %}  <!-- Vai puxar o DashBoard - parte com as informações de quantidade -->
{% load static %}

{% block title %}Gerenciar Gato Adotados{% endblock %}

{% block content%}

<link rel="stylesheet" href="{% static 'css/dashboard_admin_adocoes.css' %}">

<div class="container py-4">
    <!-- Caixa branca englobando tudo -->
    <div class="p-4 bg-white shadow-sm rounded-4">
        
        <!-- Título e botão -->
        <div class="d-flex justify-content-between align-items-center mb-3 border-bottom pb-2">
            <div>
                <h2 class="fw-bold text-primary">Gerenciar Gato Adotados</h2>
                <p class="subtitle-custom mb-0">Adicione, edite ou remova  gatos Adotados</p>
            </div>
            <a href="{% url 'adocoes:registrar_adocao' %}" class="btn btn-danger fw-bold shadow-sm rounded-3"> + Registrar adoção </a>
        </div> 

        <!-- Barra de pesquisa e filtros -->
        <form method="GET" action="">
            <div class="row justify-content-center mb-4">
                <!-- Filtro_Nome -->
                <div class="col-md-2 col-sm-4 mb-2"> 
                    <input type="text" name="nome" class="form-control form-control-sm search-input" placeholder="Nome do Gato" onkeyup="debounceSubmit(this.form, 600)" value="{{ request.GET.nome|default:'' }}">
                </div>

            </div>
        </form>

        <!-- Cards dos Gatos -->
        <div class="row g-4">
            {% for adotado in adotados %}
            <div class="col-lg-3 col-md-4 col-sm-6">

                <!-- Div que vai puxar todas as informações do gato, para que seja usado no pop-up - usando Javascript -->
                <div class="card abrir-modal-gato border-0 h-100 rounded-4 overflow-hidden"
                        data-nome="{{ adotado.gato.nome }}"
                        data-idade="{{ adotado.gato.idade }}"
                        data-sexo="{{ adotado.gato.get_sexo_display }}"
                        data-historia="{{ adotado.gato.descricao }}"
                        data-detalhes="{{ adotado.gato.temperamento }}, {{ adotado.gato.cuidado }}, {{ adotado.gato.sociavel }}, {{ adotado.gato.moradia }}"
                        data-imagem="{% if adotado.imagem %}{{ adotado.imagem.url }}{% endif %}"
                        data-adotante-nome="{{ adotado.adotante_nome }}"
                        data-adotante-email="{{ adotado.adotante_email }}"
                        data-adotante-telefone="{{ adotado.adotante_telefone }}">

                    {% if adotado.imagem %}
                        <img src="{{ adotado.imagem.url }}" class="card-img-top" alt="{{ adotado.gato.nome }}" style="object-fit: cover; height: 200px;"> 
                    {% else %} 
                        <img src="https://placehold.co/300x200?text=Sem+Foto" class="card-img-top" alt="Sem imagem">
                    {%endif%}
                    <div class="card-body d-flex flex-column">
                        <!-- Nome e ícones de ação - "Parte de baixo" do card -->
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h5 class="card-title mb-0 text-primary fw-bold">
                                <span class="text-primary fw-bold">{{ adotado.adotante_primeiro_nome }}</span>
                                adotou
                                <span class="text-primary fw-bold">{{ adotado.gato.nome }}</span>
                            </h5>
                            <div class="d-flex gap-1"> 
                                <a href="{% url 'gatos:editar_gato' adotado.gato.id %}" class="btn btn-light p-1" title="Editar"> 
                                    <img src="{% static 'img/Icone_Editar.svg' %}" alt="Editar" style="width: 35px; height: 35px;"> 
                                </a> 
                                <a href="javascript:void(0);" class="btn btn-light p-1 excluir-adotado" data-id="{{ adotado.id }}" data-nome="{{ adotado.gato.nome }}" title="Excluir">
                                    <img src="{% static 'img/Icone_Excluir.svg' %}" alt="Excluir" style="width: 35px; height: 35px;">
                                </a> 
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Caso não tenha nenhum gato -->
            {% empty %}
            <p class="text-muted text-center">Nenhum gato foi Adotado.</p>

            {% endfor %}

        </div>
    </div>
</div>


<!-- Pop-up/Modal de Detalhes do Gato -->
<div id="modalGato" class="modal fade" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content border-0 shadow-lg rounded-4" style="border: 2px solid #d7caff;">

    <!-- Botão de fechar o model -->
    <div class="modal-header border-0">
        <button type="button" class="btn-close btn-fechar-modal" data-bs-dismiss="modal" aria-label="Fechar"></button>
    </div>

      <div class="modal-body p-4">
        <div class="row align-items-center g-4">
          
        <!-- Imagem do gato -->
        <div class="col-md-5 d-flex justify-content-center">
            <img id="modalImagem" src="" alt="Gato" class="rounded-3 shadow-sm">
        </div>

        <!-- Conteúdo -->
        <div class="col-md-7">
            <!-- Nome do Gato -->
            <h2 id="modalNome" class="fw-bold mb-1"></h2>
            <!-- Sexo e idade do Gato -->
            <p id="modalInfo" class="text-muted mb-4" style="font-size: 15px; color:#96B3E5;"></p>

            <!-- Título "História de ..." -->
            <h6 class="fw-bold mb-1" style="color:#F58285;">História de <span id="modalNomeHistoria"></span></h6>
            <!-- Descrição do gato - História do Gato -->
            <p id="modalHistoria" class="text-secondary mb-4 small" style="color:#4F76BB;"></p>

            <!-- Título "Mais detalhes sobre ..." - Tabelas Auxiliares -->
            <h6 class="fw-bold mb-2" style="color:#F58285;">Mais detalhes sobre <span id="modalNomeDetalhes"></span></h6>
            <!-- Todos que estão marcados com True nas tabelas auxiliares -->
            <div id="modalDetalhes" class="d-flex flex-wrap gap-2"></div>

            </div>
          </div>
        </div>

        <!-- Apresenta as informações do adotante -->

        <div id="modalAdotante" class="mt-4">
            
            <div class="row justify-content-center"> 
                
                <div class="col-12 col-md-10 col-lg-8">
                    
                    <h6 class="text-center fw-bold mb-3" style="color: #ff8c8c;">Adotante</h6>
                    
                    <!-- Nome -->
                    <div class="p-2 mb-2 rounded" style="background-color: #e6e9f6; color: #3b5998;"> Nome:
                        <span id="modalAdotanteNome" class="ps-2" style="color: #3b5998;"></span>
                    </div>
                    
                    <!-- Email -->
                    <div class="p-2 mb-2 rounded" style="background-color: #e6e9f6; color: #3b5998;"> Email: 
                        <span id="modalAdotanteEmail" class="ps-2" style="color: #3b5998;"></span>
                    </div>
                    
                    <!-- Telefone -->
                    <div class="p-2 mb-2 rounded" style="background-color: #e6e9f6; color: #3b5998;"> Telefone:
                        <span id="modalAdotanteTelefone" class="ps-2" style="color: #3b5998;"></span>
                    </div><br>
                    
                </div>
            </div>
        </div>

      </div>
    </div>
  </div>
</div>


<!-- JavaScript -->

<script>

// Mini função para o filtro de Nome.
// Para dar um delay antes de pesquisar, para que a pessoa consiga digitar todo o nome

    let debounceTimer;

    function debounceSubmit(form, delay) {
        clearTimeout(debounceTimer); // reseta o timer se ainda estiver contando
        debounceTimer = setTimeout(() => {
            form.submit(); // envia o form só depois do delay
        }, delay);
    }


// Função para o Pop-up de confirmar exclusão - Feito em JavaScript e Ajax ( Não sei explicar - Raí )

    document.addEventListener("DOMContentLoaded", function() {
        const botoesExcluir = document.querySelectorAll(".excluir-adotado");

        botoesExcluir.forEach(btn => {
            btn.addEventListener("click", function() {
                const adotadoId = this.dataset.id;
                const gatoNome = this.dataset.nome;

                if (confirm(`Tem certeza que deseja excluir o registro de adoção do gato ${gatoNome}?`)) {
                    fetch(`/adocoes/excluir_adotado_ajax/${adotadoId}/`, {
                        method: "POST",
                        headers: {
                            "X-CSRFToken": "{{ csrf_token }}",
                            "Accept": "application/json",
                        },
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === "ok") {
                            // Remove o card da tela
                            const card = this.closest(".col-lg-3, .col-md-4, .col-sm-6");
                            if (card) card.remove();
                            alert(data.mensagem);
                        } else {
                            alert(data.mensagem);
                        }
                    })
                    .catch(err => {
                        console.error(err);
                        alert("Ocorreu um erro ao tentar excluir o registro de adoção.");
                    });
                }
            });
        });
    });
// Parte em Javascript do Modal - Pop-up de informações do gato
document.addEventListener('DOMContentLoaded', function() {
  const modalElement = document.getElementById('modalGato');
  const modal = new bootstrap.Modal(modalElement);

  // Elementos do modal
  const modalNome = document.getElementById('modalNome');
  const modalInfo = document.getElementById('modalInfo');
  const modalNomeHistoria = document.getElementById('modalNomeHistoria');
  const modalNomeDetalhes = document.getElementById('modalNomeDetalhes');
  const modalHistoria = document.getElementById('modalHistoria');
  const modalDetalhes = document.getElementById('modalDetalhes');
  const modalImagem = document.getElementById('modalImagem');

  // Elementos da seção do adotante (HTML fixo no modal)
  const modalAdotanteNome = document.getElementById('modalAdotanteNome');
  const modalAdotanteEmail = document.getElementById('modalAdotanteEmail');
  const modalAdotanteTelefone = document.getElementById('modalAdotanteTelefone');

  // Seleciona todos os cards clicáveis
  document.querySelectorAll('.abrir-modal-gato').forEach(card => {
    card.addEventListener('click', e => {
      // Impede que o clique no botão "excluir" ou "editar" dentro do card também abra o modal
      if (e.target.closest('.btn')) return;

      // Evita conflitos de imagem entre modal e cards
      modalElement.querySelectorAll('img').forEach(img => {
        if (img.id !== 'modalImagem') img.removeAttribute('src');
      });

      // Pega os dados do gato
      const nome = card.dataset.nome;
      const idade = card.dataset.idade;
      const sexo = card.dataset.sexo;
      const historia = card.dataset.historia;
      const detalhes = card.dataset.detalhes;
      const imagem = card.dataset.imagem;

      // Preenche o conteúdo do gato
      modalNome.textContent = nome || "Sem nome";
      modalInfo.textContent = `${idade} | ${sexo}`;
      modalNomeHistoria.textContent = nome;
      modalNomeDetalhes.textContent = nome;
      modalHistoria.textContent = historia || "Sem descrição cadastrada.";
      modalImagem.src = imagem || "https://placehold.co/300x200?text=Sem+Imagem";

      // Limpa e recria os detalhes (tags)
      modalDetalhes.innerHTML = "";
      if (detalhes) {
        detalhes.split(',').forEach(item => {
          const texto = item.trim();
          if (texto) {
            const span = document.createElement('span');
            span.className = 'tag';
            span.textContent = texto;
            modalDetalhes.appendChild(span);
          }
        });
      }

      // Preenche os dados do adotante (HTML fixo)
      modalAdotanteNome.textContent = card.dataset.adotanteNome || '—';
      modalAdotanteEmail.textContent = card.dataset.adotanteEmail || '—';
      modalAdotanteTelefone.textContent = card.dataset.adotanteTelefone || '—';

      // Exibe o modal
      modal.show();
    });
  });
});


</script>

{% endblock %}