<!-- Html da p√°gina dashboard_admin_lar_temporario
P√°gina do dashboard que mostra os gatos para Lar Tempor√°rio -->


{% extends "ong/base_admin.html" %} <!-- Vai puxar o DashBoard - parte com as informa√ß√µes de quantidade -->
{% load static %}

{% block title %}Gerenciar Gatos para Lar Tempor√°rio{% endblock %}

{% block content %}

<link rel="stylesheet" href="{% static 'css/dashboard_admin_adocoes.css' %}">

<div class="container py-4">
    <!-- Caixa branca englobando tudo -->
    <div class="p-4 bg-white shadow-sm rounded-4">
        
        <!-- T√≠tulo e bot√£o -->
        <div class="d-flex justify-content-between align-items-center mb-3 border-bottom pb-2">
            <div>
                <h2 class="fw-bold text-primary">Gerenciar Gatos para Lar Tempor√°rio</h2>
                <p class="subtitle-custom mb-0">Adicione, edite ou remova gatos para Lar Tempor√°rio</p>
            </div>
            <a href="{% url 'lares_temporarios:registrar_lar_temporario' %}" class="btn btn-danger fw-bold shadow-sm rounded-3"> + Registrar Lar Tempor√°rio </a>
        </div> 

        <!-- Barra de pesquisa e filtros -->
        <form method="GET" action="">
            <div class="row justify-content-center mb-4">
                <!-- Filtro_Nome -->
                <div class="col-md-2 col-sm-4 mb-2"> 
                    <input type="text" name="nome" class="form-control form-control-sm search-input" placeholder="Nome do Gato" onkeyup="debounceSubmit(this.form, 600)" value="{{ request.GET.nome|default:'' }}">
                </div>
                <!-- Filtro_Sexo -->
                <div class="col-md-2 col-sm-4 mb-2">
                    <select name="sexo" class="form-select form-select-sm search-input" onchange="this.form.submit()">
                        <option value="">Todos os sexos</option>
                        <option value="M" {% if request.GET.sexo == "M" %}selected{% endif %}>Macho</option>
                        <option value="F" {% if request.GET.sexo == "F" %}selected{% endif %}>F√™mea</option>
                    </select>
                </div>
            </div>
        </form>

        <!-- Cards dos Gatos - Lar Tempor√°rio -->
        <div class="row g-4">
            {% for gato in gatos %}
            <div class="col-lg-3 col-md-4 col-sm-6">

                <!-- Div que vai puxar todas as informa√ß√µes do gato, para que seja usado no pop-up - usando Javascript -->
                <div class="card abrir-modal-gato border-0 h-100 rounded-4 overflow-hidden" style="position: relative;"
                    data-id="{{ gato.id }}"
                    data-nome="{{ gato.nome }}"
                    data-idade="{{ gato.idade }}"
                    data-sexo="{{ gato.get_sexo_display }}"
                    data-historia="{{ gato.descricao }}"
                    data-detalhes="{{ gato.temperamento }}, {{ gato.cuidado }}, {{ gato.sociavel }}, {{ gato.moradia }}"
                    data-imagem="{{ gato.imagem.url }}"
                    data-lar-atual-id="{% if gato.lar_atual %}{{ gato.lar_atual.id }}{% endif %}"
                    data-adotar="#"
                    data-lar-atual="{% if gato.lar_atual %}
                        {{ gato.lar_atual.lar_temporario.nome }},
                        {{ gato.lar_atual.lar_temporario.email }},
                        {{ gato.lar_atual.lar_temporario.numero_contato }},
                        {{ gato.lar_atual.lar_temporario.rua }} - 
                        {{ gato.lar_atual.lar_temporario.numero }} | 
                        {{ gato.lar_atual.lar_temporario.bairro }} | 
                        {{ gato.lar_atual.lar_temporario.cidade }},
                        {{ gato.lar_atual.data_inicio }}
                    {% endif %}"
                    data-historico='[
                        {% for h in gato.historico_lares %}
                            {
                                "id": "{{ h.id }}",
                                "nome": "{{ h.lar_temporario.nome }}",
                                "email": "{{ h.lar_temporario.email }}",
                                "numero_contato": "{{ h.lar_temporario.numero_contato }}",
                                "endereco": "{{ h.lar_temporario.rua }} - {{ h.lar_temporario.numero }} | {{ h.lar_temporario.bairro }} | {{ h.lar_temporario.cidade }}",
                                "data_inicio": "{{ h.data_inicio }}",
                                "data_fim": "{{ h.data_fim }}"
                            }{% if not forloop.last %},{% endif %}
                        {% endfor %}
                    ]'
                    >

                    <!-- Status - Se est√° ou n√£o em um Lar Tempor√°rio -->
                    {% if gato.em_lar %}
                        <div class="position-absolute top-0 end-0 m-2 px-3 py-1 fw-bold rounded-3" style="background-color: #B0EEB2; font-size: 0.9rem; color: #227B0C;">
                            Em Lar Tempor√°rio
                        </div>
                    {% else %}
                        <div class="position-absolute top-0 end-0 m-2 px-3 py-1 fw-bold rounded-3" style="background-color: #EEB0B0; font-size: 0.9rem; color: #7B0C0C;">
                            Sem Lar Tempor√°rio
                        </div>
                    {% endif %}

                    <!-- Icone de Finalizar Lar Temporario -->
                    {% if gato.em_lar %}
                        <a href="{% url 'lares_temporarios:finalizar_lar_temporario' gato.id %}" class="icone-finalizar">
                            <img src="{% static 'img/finalizar-check.png' %}" alt="Finalizar">
                        </a>
                    {% endif %}

                    <!-- Imagem -->
                    {% if gato.imagem %}
                        <img src="{{ gato.imagem.url }}" class="card-img-top" alt="{{ gato.nome }}" style="object-fit: cover; height: 200px;">
                    {% else %}
                        <img src="https://placehold.co/300x200?text=Sem+Foto" class="card-img-top" alt="Sem imagem">
                    {% endif %}


                    <!-- Corpo do Card - "Parte de baixo" do card -->
                    <div class="card-body d-flex flex-column">
                        <!-- Nome  -->
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h5 class="card-title mb-0 fw-bold text-primary">{{ gato.nome }}</h5>
                        </div>

                        <!-- Sexo e idade -->
                        <p class="card-text mb-2 text-muted small"> {{ gato.idade }} |
                            {% if gato.sexo == 'M' %}
                            Macho
                            {% else %}
                            F√™mea
                            {% endif %}
                        </p>
                    </div>

                </div>
            </div>

            <!-- Caso n√£o tenha nenhum gato de Lar Tempor√°rio -->
            {% empty %}
            <p class="text-muted text-center">Nenhum gato cadastrado para lar tempor√°rio.</p>

            {% endfor %}

        </div>
    </div>
</div>


<!-- Pop-up/Modal de Detalhes do Gato -->
<div id="modalGato" class="modal fade" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content border-0 shadow-lg rounded-4" style="border: 2px solid #d7caff;">

      <!-- Bot√£o de fechar o model -->
      <div class="modal-header border-0">
        <button type="button" class="btn-close btn-fechar-modal" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>

      <div class="modal-body p-4">
        <div class="row align-items-center g-4">

          <!-- Imagem do gato -->
          <div class="col-md-5 d-flex justify-content-center">
            <img id="modalImagem" src="" alt="Gato" class="rounded-3 shadow-sm">
          </div>

          <!-- Conte√∫do -->
          <div class="col-md-7">

            <!-- Nome do Gato -->
            <h2 id="modalNome" class="fw-bold mb-1"></h2>

            <!-- Sexo e idade do Gato -->
            <p id="modalInfo" class="text-muted mb-4" style="font-size: 15px; color:#96B3E5;"></p>

            <!-- T√≠tulo "Hist√≥ria de ..." -->
            <h6 class="fw-bold mb-1" style="color:#F58285;">
              Hist√≥ria de <span id="modalNomeHistoria"></span>
            </h6>

            <!-- Descri√ß√£o do gato - Hist√≥ria -->
            <p id="modalHistoria" class="text-secondary mb-4 small" style="color:#4F76BB;"></p>

            <!-- T√≠tulo "Mais detalhes sobre ..." -->
            <h6 class="fw-bold mb-2" style="color:#F58285;">
              Mais detalhes sobre <span id="modalNomeDetalhes"></span>
            </h6>

            <!-- Detalhes -->
            <div id="modalDetalhes" class="d-flex flex-wrap gap-2"></div>

          </div> <!-- fim col-md-7 -->

            <!-- LAR ATUAL -->
            <div class="mt-4">
              <h5 class="fw-bold">Lar Tempor√°rio Atual</h5>
              <div id="modalLarAtual"></div>
            </div>

            <!-- HIST√ìRICO -->
            <div class="mt-4">
              <h5 class="fw-bold">Hist√≥rico de Lares Tempor√°rios</h5>
              <div id="modalHistorico"></div>
            </div>

        </div> <!-- row -->
      </div> <!-- modal-body -->

    </div>
  </div>
</div>



<!-- JavaScript -->

<script>

// Mini fun√ß√£o para o filtro de Nome.
// Para dar um delay antes de pesquisar, para que a pessoa consiga digitar todo o nome

    let debounceTimer;

    function debounceSubmit(form, delay) {
        clearTimeout(debounceTimer); // reseta o timer se ainda estiver contando
        debounceTimer = setTimeout(() => {
            form.submit(); // envia o form s√≥ depois do delay
        }, delay);
    }


// Fun√ß√£o para o Pop-up de confirmar exclus√£o - Feito em JavaScript e Ajax ( N√£o sei explicar - Ra√≠ )

    document.addEventListener("DOMContentLoaded", function() {
        const botoesExcluir = document.querySelectorAll(".excluir-gato");

        botoesExcluir.forEach(btn => {
            btn.addEventListener("click", function() {
                const gatoId = this.dataset.id;
                const gatoNome = this.dataset.nome;

                if (confirm(`Tem certeza que deseja excluir o gato ${gatoNome} e todos os registros associados?`)) {
                    fetch(`/excluir_gato_ajax/${gatoId}/`, {
                        method: "POST",
                        headers: {
                            "X-CSRFToken": "{{ csrf_token }}",
                            "Accept": "application/json",
                        },
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === "ok") {
                            // Remove o card da tela
                            const card = this.closest(".col-lg-3, .col-md-4, .col-sm-6");
                            if (card) card.remove();
                            alert(data.mensagem);
                        } else {
                            alert(data.mensagem);
                        }
                    })
                    .catch(err => {
                        console.error(err);
                        alert("Ocorreu um erro ao tentar excluir o gato.");
                    });
                }
            });
        });
    });


// Parte em Javascript do Model - Pop-up de informa√ß√µes do gato
document.addEventListener('DOMContentLoaded', function() {
  const modalElement = document.getElementById('modalGato');
  const modal = new bootstrap.Modal(modalElement);

  // Campos do modal
  const modalNome = document.getElementById('modalNome');
  const modalInfo = document.getElementById('modalInfo');
  const modalNomeHistoria = document.getElementById('modalNomeHistoria');
  const modalNomeDetalhes = document.getElementById('modalNomeDetalhes');
  const modalHistoria = document.getElementById('modalHistoria');
  const modalDetalhes = document.getElementById('modalDetalhes');
  const modalImagem = document.getElementById('modalImagem');
  const modalLarAtual = document.getElementById('modalLarAtual');
  const modalHistorico = document.getElementById('modalHistorico');

  // Seleciona todos os cards clic√°veis
  document.querySelectorAll('.abrir-modal-gato').forEach(card => {
    card.addEventListener('click', e => {

      // Impede clique em bot√µes dentro do card
        if (e.target.closest('.btn-editar') || 
            e.target.closest('.btn-excluir') ||
            e.target.closest('.btn-finalizar') || 
            e.target.closest('.icone-finalizar')) 
        {
            e.stopPropagation();
            return;
        }


      // Garantir que apenas o modal carrega imagens dele mesmo
      modalElement.querySelectorAll('img').forEach(img => {
        if (img.id !== 'modalImagem') {
          img.removeAttribute('src');
        }
      });

      // ================================
      // PEGAR DADOS DO CARD
      // ================================
      const nome = card.dataset.nome;
      const idade = card.dataset.idade;
      const sexo = card.dataset.sexo;
      const historia = card.dataset.historia;
      const detalhes = card.dataset.detalhes;
      const imagem = card.dataset.imagem;

      // LAR TEMPOR√ÅRIO ATUAL (string)
      const larAtualStr = card.dataset.larAtual?.trim();

      // HIST√ìRICO (JSON vindo do template)
      let historico = [];
      try {
        historico = JSON.parse(card.dataset.historico || "[]");
      } catch (err) {
        console.error("Erro ao ler hist√≥rico:", err);
      }

      // ================================
      // PREENCHER MODAL - CAMPOS SIMPLES
      // ================================
      modalNome.textContent = nome || "Sem nome";
      modalInfo.textContent = `${idade} | ${sexo}`;
      modalNomeHistoria.textContent = nome;
      modalNomeDetalhes.textContent = nome;
      modalHistoria.textContent = historia || "Sem descri√ß√£o cadastrada.";
      modalImagem.src = imagem || "https://placehold.co/300x200?text=Sem+Imagem";

      // ================================
      // DETALHES (Temperamento, Cuidado...)
      // ================================
      modalDetalhes.innerHTML = "";
      if (detalhes) {
        detalhes.split(',').forEach(item => {
          const texto = item.trim();
          if (texto) {
            const span = document.createElement('span');
            span.className = 'tag';
            span.textContent = texto;
            modalDetalhes.appendChild(span);
          }
        });
      }

    // ================================
    // LAR TEMPOR√ÅRIO ATUAL
    // ================================
    modalLarAtual.innerHTML = "";

    if (larAtualStr && larAtualStr.length > 5) {

        const partes = larAtualStr.split(',').map(p => p.trim());

        modalLarAtual.innerHTML = `
            <div class="caixa-lar">
                <p>${partes[0] || "-"}</p>
                <p>${partes[1] || "-"}</p>
                <p>${partes[2] || "-"}</p>
                <p>${partes[3] || "-"}, </p>
                <p><strong>In√≠cio:</strong> ${partes[4] || "-"}, ${partes[5] || "-"}</p>
                <div class="botoes-lar mt-3">
                    <button class="btn-editar">Editar</button>
                    <button class="btn-excluir" data-id="${card.dataset.larAtualId}">Excluir</button>
                    <a class="btn-finalizar">Finalizar</a>
                </div>
            </div>
        `;
                // üî• Adiciona o listener para o bot√£o editar LAR ATUAL
        const btnEditarLarAtual = modalLarAtual.querySelector(".btn-editar");
        if (btnEditarLarAtual) {
            btnEditarLarAtual.addEventListener("click", () => {
                const larId = card.dataset.larAtualId;
                window.location.href = `/lares_temporarios/editar/atual/${larId}/`;
            });
        }

        // üî• AGORA que os bot√µes existem, pegamos o "Finalizar"
        const btnFinalizar = modalLarAtual.querySelector(".btn-finalizar");
        if (btnFinalizar) {
            btnFinalizar.href = `/lares_temporarios/finalizar/${card.dataset.id}/`;
        }

    } else {
        modalLarAtual.innerHTML = `
            <p class="text-muted">Sem lar tempor√°rio no momento.</p>
        `;
    }


    // ================================
    // HIST√ìRICO
    // ================================
    modalHistorico.innerHTML = `
    `;

    if (historico.length > 0) {

        historico.forEach(entry => {
            const div = document.createElement("div");
            div.className = "caixa-lar";

            div.innerHTML = `
                <p>${entry.nome}</p>
                <p>${entry.email}</p>
                <p>${entry.numero_contato}</p>
                <p>${entry.endereco}</p>
                <p><strong>In√≠cio:</strong> ${entry.data_inicio}</p>
                <p><strong>Fim:</strong> ${entry.data_fim || "‚Äî"}</p>

                <div class="botoes-lar">
                    <button class="btn-editar" data-id="${entry.id}">Editar</button>
                    <button class="btn-excluir" data-id="${entry.id}">Excluir</button>
                </div>
            `;

            modalHistorico.appendChild(div);
        });
                // üî• Adiciona listeners para os bot√µes editar do HIST√ìRICO
        modalHistorico.querySelectorAll(".btn-editar").forEach(btn => {
            btn.addEventListener("click", () => {
                const id = btn.dataset.id;
                window.location.href = `/lares_temporarios/editar/historico/${id}/`;
            });
        });

    } else {
        modalHistorico.innerHTML += `
            <p class="text-muted">Sem hist√≥rico dispon√≠vel.</p>
        `;
    }

    modalElement.dataset.gatoId = card.dataset.id;
        localStorage.setItem("modalGatoId", card.dataset.id);


      // ================================
      // MOSTRAR O MODAL
      // ================================
      modal.show();
    });
  });
});

// EVENTO PARA EXCLUIR LAR ATUAL OU HIST√ìRICO ‚Äî DENTRO DO MODAL
document.addEventListener("click", function(e) {

    if (e.target.classList.contains("btn-excluir")) {

        const id = e.target.dataset.id;
        const bloco = e.target.closest(".caixa-lar");

        // üîç Detectar se √© LAR ATUAL ou HIST√ìRICO
        const ehLarAtual = bloco.parentElement.id === "modalLarAtual";
        
        // Adiciona uma refer√™ncia ao modal para poder escond√™-lo
        const modalElement = document.getElementById('modalGato');
        const modal = bootstrap.Modal.getInstance(modalElement); 

        const confirmDelete = confirm(
            ehLarAtual 
            ? "Deseja remover o LAR TEMPOR√ÅRIO ATUAL deste gato?" 
            : "Deseja excluir este registro do HIST√ìRICO?"
        );

        if (!confirmDelete) return;

        const url = ehLarAtual
            ? `/lares_temporarios/excluir_lar_temporario_atual_ajax/${id}/`
            : `/lares_temporarios/excluir_historico_lar_temporario_ajax/${id}/`;

        fetch(url, {
            method: "POST",
            headers: {
                "X-CSRFToken": "{{ csrf_token }}",
                "Accept": "application/json"
            }
        })
        .then(r => r.json())
        .then(data => {
            if (data.status === "ok") {

                bloco.remove(); // ‚úÖ Remove a caixinha visual

                alert(data.mensagem);

                // Se o lar atual foi removido ‚Üí recarregar cards
                if (ehLarAtual) {
                    location.reload();
                } else {
                    // ‚≠êÔ∏è NOVO: Se o hist√≥rico foi removido, feche o modal.
                    if (modal) {
                         modal.hide();
                    }
                    // E recarregue a p√°gina ap√≥s fechar o modal.
                    location.reload(); 
                }

            } else {
                alert(data.mensagem);
            }
        })
        .catch(() => alert("Erro ao processar exclus√£o."));
    }

});

</script>

{% endblock %}