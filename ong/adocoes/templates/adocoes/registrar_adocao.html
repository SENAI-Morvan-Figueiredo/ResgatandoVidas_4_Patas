{% extends "ong/base.html" %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/registrar_adocao.css' %}">
<link rel="stylesheet" href="{% static 'css/adocao.css' %}">

<a href="{% url 'administrador:dashboard_admin_adotados' %}" class="back-link">&larr; Voltar</a>

<div class="form-container">
    <h1 class="form-title">
    {% if adotado %}EDITAR ADOÇÃO{% else %}REGISTRAR UMA ADOÇÃO{% endif %}
    </h1>

    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}

        <label>Gato</label>
        <select name="gato" id="select-gato" class="form-control" required>
            <option value="">Selecione o gato</option>
            {% for gato in gatos %}
                <option value="{{ gato.id }}"
                    {% if adotado and adotado.gato.id == gato.id %}selected{% endif %}>
                    {{ gato.nome }}
                    {% if gato.lar_temporario %}(Em Lar Temporário){% endif %}
                </option>
            {% endfor %}
        </select>

        <label>Adotante</label>
        <select name="adotante" id="select-adotante" class="form-control" required>
            <option value="">Selecione o adotante</option>
            {% for adotante in adotantes %}
                <option value="{{ adotante.id }}"
                    {% if adotado and adotado.adocao.id == adotante.id %}selected{% endif %}>
                    {{ adotante.nome }} — {{ adotante.email }}
                </option>
            {% endfor %}
        </select>

        <label>Início</label>
        <input type="date" name="data_inicio"
            value="{% if adotado %}{{ adotado.data_inicio|date:'Y-m-d' }}{% endif %}"
            required>


        <label>Foto do gato</label>
        <input type="file" name="foto">

        <button type="submit">Registrar</button>
    </form>

</div>


<!-- Javascript -->

<!-- ---------------------------------------------------------
Ajax para carregar os adotantes disponíveis para o gato selecionado
--------------------------------------------------------- -->

<script>
document.getElementById("select-gato").addEventListener("change", function () {
    let gatoId = this.value;
    let selectAdotante = document.getElementById("select-adotante");

    // Limpa e mostra carregando
    selectAdotante.innerHTML = "<option value=''>Carregando...</option>";

    if (!gatoId) {
        selectAdotante.innerHTML = "<option value=''>Selecione o gato primeiro</option>";
        return;
    }

    // Chama a URL configurada no urls.py
    fetch(`/adocoes/buscar_adotantes/${gatoId}/`) 
        .then(response => response.json())
        .then(data => {
            selectAdotante.innerHTML = "<option value=''>Selecione o adotante</option>";

            if (data.length === 0) {
                 selectAdotante.innerHTML = "<option value=''>Nenhum formulário encontrado para este gato</option>";
                 return;
            }

            data.forEach(a => {
                let opt = document.createElement("option");
                opt.value = a.id;
                // a.nome e a.email vêm do values() na view Python
                opt.textContent = `${a.nome} — ${a.email}`; 
                selectAdotante.appendChild(opt);
            });
        })
        .catch(error => {
            console.error('Erro ao buscar adotantes:', error);
            selectAdotante.innerHTML = "<option value=''>Erro ao carregar adotantes</option>";
        });
});

// Inicialização: Remove os adotantes que foram carregados (mas serão substituídos pelo AJAX)
// Garante que o select esteja limpo se o gato já estiver pré-selecionado (para a edição, se fosse o caso)
document.addEventListener("DOMContentLoaded", function() {
    let selectAdotante = document.getElementById("select-adotante");
    selectAdotante.innerHTML = "<option value=''>Selecione o gato primeiro</option>";
});
</script>

{% endblock %}
